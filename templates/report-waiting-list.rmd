---
title: "TARGET-UK: Waiting List Report"
output:
  html_document:
    toc: false
  pdf_document:
    toc: false
    latex_engine: xelatex
header-includes: |
  \usepackage{pdflscape}
  \usepackage{xcolor}
  \setlength{\fboxsep}{6pt}   % padding inside color boxes
classoption: landscape
params:
  tci_start_date: !r Sys.Date()
  first_ref_date: !r Sys.Date() - 365
  last_ref_date:  !r Sys.Date() + 365
  report_organs: ["Liver", "Lung", "Kidney", "Adrenal", "Other"]
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(out.width = "100%")
options(knitr.table.format = "html")

library(dplyr)
library(kableExtra)
library(webshot2)
library(htmlwidgets)
library(htmltools)

tci_start_date    <- params$tci_start_date
report_start_date <- params$first_ref_date
report_end_date   <- params$last_ref_date
report_organs     <- params$report_organs
tciStart          <- as.Date(tci_start_date)
reportStart       <- as.Date(report_start_date)
reportEnd         <- as.Date(report_end_date)

output_dir <- file.path("..",Sys.getenv("REPORT_OUTPUT_DIR"))
output_dir <- tempdir()
out_html <- file.path(output_dir,"tci_calendar.html")
out_pdf  <- file.path(output_dir,"tci_calendar.pdf")
#out_html <- "tci_calendar.html"
#out_pdf  <- "tci_calendar.pdf"
            
# Remove Dummy patient numbers from the data
rxWaitReportData <- rxWaitData |>
  filter((ID != "000-1" & ID != "00000-1" & ID != "000000-1"))

# Filter to just the organs of interest
if (!("All Organs" %in% report_organs)) {
  rxWaitReportData <- rxWaitReportData |>
    dplyr::filter(Organs %in% report_organs)
}

# Filter to just the referral date period of interest
rxWaitReportData <- rxWaitReportData |>
  filter(RefDate >= reportStart & RefDate <= reportEnd)

# Add the pre- and post-DTT clockstops to save a column
rxWaitReportData$ClockStopDays <- rowSums(cbind(rxWaitReportData$ClockStopDaysPreDTT,rxWaitReportData$ClockStopDaysPostDTT), na.rm=T)
rxWaitReportData <- subset(rxWaitReportData, select = -c(ClockStopDaysPreDTT,ClockStopDaysPostDTT,ClockStopWhy))

rxClockStopData <- subset(rxWaitData, select = c(ID, ClockStopDaysPreDTT, ClockStopDaysPostDTT, ClockStopWhy ))
rxClockStopData <- dplyr::filter(rxClockStopData, !is.na(ClockStopDaysPreDTT) | !is.na(ClockStopDaysPostDTT))

# Remove the Ref_DTT column to save space
rxWaitReportData <- subset(rxWaitReportData, select = -c(Ref_DTT))

# Rename column DaysWaiting to DaysSinceReferral so its clearer
rxWaitReportData <- rxWaitReportData %>% rename(DaysSinceReferral = DaysWaiting)

# Sort by TCI date
# rxWaitReportData <- rxWaitReportData %>% arrange(desc(TciDate))

# Sort by Patient ID
rxWaitReportData <- rxWaitReportData %>% arrange(order(ID))

# Make the TCI calendar
tciCalendar <- makeTciCalendar(tciStart,TRUE,FALSE)

generatedTime <- format(Sys.time(), "%a %b %d %X %Y")
```

<!-- PCL: I had to do an ugly global variable hack to get report_start_date and report_end_date visible from this file, but it works-->

Organs included: `r paste(report_organs)`<br>

## TCI Booking Calendars

```{r tciCalendar, echo = FALSE, warning = FALSE, results='asis'}
if (isChromeInstalled()) {
  library(lubridate)
  library(htmltools)
  library(htmlwidgets)
  library(webshot2)
  library(knitr)

  # Dates
  tciThisMonth <- as.Date(tci_start_date)
  tciNextMonth <- tciThisMonth %m+% months(1)

  # Create two widgets
  cal_this_month <- makeTciCalendar(tciThisMonth, report_organs, TRUE, FALSE)
  cal_next_month <- makeTciCalendar(tciNextMonth, report_organs, TRUE, FALSE)

  # Output dir and file paths (unique)
  output_dir <- tempdir()
  html_this  <- file.path(output_dir, paste0("tci_", format(tciThisMonth, "%Y_%m_%d"), ".html"))
  png_this   <- file.path(output_dir, paste0("tci_", format(tciThisMonth, "%Y_%m_%d"), ".png"))
  html_next  <- file.path(output_dir, paste0("tci_", format(tciNextMonth, "%Y_%m_%d"), ".html"))
  png_next   <- file.path(output_dir, paste0("tci_", format(tciNextMonth, "%Y_%m_%d"), ".png"))

  # Wrap each widget in its own wrapper and save a standalone HTML page
  page_this <- tagList(
    tags$head(tags$style(HTML("html,body{margin:0;padding:0;} #calendar-wrapper-this{height:1000px !important;} #calendar-wrapper-this .htmlwidget{height:100% !important;}"))),
    tags$div(id = "calendar-wrapper-this", cal_this_month)
  )
  page_next <- tagList(
    tags$head(tags$style(HTML("html,body{margin:0;padding:0;} #calendar-wrapper-next{height:1000px !important;} #calendar-wrapper-next .htmlwidget{height:100% !important;}"))),
    tags$div(id = "calendar-wrapper-next", cal_next_month)
  )

  # Save pages (note: save the pages we just built)
  htmltools::save_html(page_this, file = html_this)
  htmltools::save_html(page_next, file = html_next)

  # Build file:// URLs for the specific pages we just saved
  url_this <- paste0("file://", normalizePath(html_this))
  url_next <- paste0("file://", normalizePath(html_next))

  # Screenshot each wrapper by the correct selector (match the wrapper IDs above)
  # increase delay if the calendar JS needs extra time
  suppressWarnings(suppressMessages(
    webshot2::webshot(url      = url_this,
                      file     = png_this,
                      selector = "#calendar-wrapper-this",
                      vwidth   = 800,
                      vheight  = 1000,
                      zoom     = 5,
                      delay    = 2,
                      cliprect = "viewport")))
  suppressWarnings(suppressMessages(
    webshot2::webshot(url      = url_next,
                      file     = png_next,
                      selector = "#calendar-wrapper-next",
                      vwidth   = 800,
                      vheight  = 1000,
                      zoom     = 5,
                      delay    = 2,
                      cliprect = "viewport")))
  
  # Insert the calendar key
  if (knitr::is_latex_output()) {
    getTciCalendarKey()
  } else {
    cat(as.character(getTciCalendarKey()))
  }
  
  # show key and embed PNGs (works for PDF and HTML)
  if (knitr::is_latex_output()) {
    cat(sprintf("## TCI Calendar: %s</p>", format(tciThisMonth, "%b %Y")))
    print(knitr::include_graphics(png_this))
    cat(sprintf("## TCI Calendar: %s</p>", format(tciNextMonth, "%b %Y")))
    print(knitr::include_graphics(png_next))
  } else {
    cat(sprintf("<h3>TCI Calendar for %s</p>", format(tciThisMonth, "%b %Y"),"</h3>"))
    cat(sprintf(
      '<img src="file://%s" style="width:100%%; height:auto; border:1px solid #ddd; margin-bottom:20px;" />',
      normalizePath(png_this)
    ))
    cat(sprintf("<h3>TCI Calendar for %s</p>", format(tciNextMonth, "%b %Y"),"</h3>"))
    cat(sprintf(
      '<img src="file://%s" style="width:100%%; height:auto; border:1px solid #ddd; margin-bottom:20px;" />',
      normalizePath(png_next)
    ))
  }

  # debug: list created files
  #cat("<p>Saved files (tempdir):</p><ul>")
  #cat(sprintf("<li>%s</li>", normalizePath(html_this)))
  #cat(sprintf("<li>%s</li>", normalizePath(png_this)))
  #cat(sprintf("<li>%s</li>", normalizePath(html_next)))
  #cat(sprintf("<li>%s</li>", normalizePath(png_next)))
  #cat("</ul>")

} else {
  print('<br>Google chrome is not installed, so PDF version of booking calendar is omitted.  Install Chrome / Chromium for TCI Calendar here.<br>')
}
```


## Referral Details (`r paste(format(report_start_date,"%b %Y"),'-',format(report_end_date,"%b %Y"))`)

```{r echo = FALSE,  results = 'asis'}
if (nrow(rxWaitReportData) > 0)
{
options(knitr.kable.NA = '')
  kbl(rxWaitReportData, caption=paste('Current Waiting List (Created ',generatedTime,')',sep="")) %>%
    kable_styling() %>%
    column_spec(8, width = "10em")
} else {
  print("No referrals waiting for date range provided.")
}
```
Notes on TCI Table:
<ul>
  <li>Those patients without a DTT date have not yet been seen in clinic, those with a DTT date were seen in clinic in that date.</li>
  <li>Provisional is a nominal date for patients who have been seen in ablation clinic and have agreed for ablation clinic, and it is the next acailable list at that time; these dates are subject to change based on clinical urgency and other factors.</li>
  <li>Confirmed date means patients for who have been formally discussed as planning business meeting (patient may not be aware of date at time of report.)</li>
  <li>Any patient with a TCI date which has already passed who is in the table is likely to have been treated, but the treatment date has not yet been updated in the EDC
</ul>

## Clock Stops

```{r echo = FALSE,  results = 'asis'}
if (nrow(rxClockStopData) > 0)
{
  kbl(rxClockStopData, caption=paste('Waiting List Clock Stops (Created ',generatedTime,')',sep="")) %>%
    kable_styling()
}
```

## Monthy Wait List (`r paste(format(report_start_date,"%b %Y"),'-',format(report_end_date,"%b %Y"))`)

Organs included: `r paste(report_organs)`<br>

```{r waitingListPlot, echo = FALSE, warning = FALSE}
makeWaitingListPlot(report_start_date, report_end_date, report_organs)
```

## Treatment Capacity Heatmaps (`r paste(format(report_start_date,"%Y"),'-',format(report_start_date+365,"%Y"))`)

Includes both treated and TCI dates for all organs<br>
```{r tciCalendarThisYear, echo = FALSE, warning = FALSE}
makeCalendarHeatmap(report_start_date, report_organs, TRUE)
```

```{r tciCalendarNextYear, echo = FALSE, warning = FALSE}
makeCalendarHeatmap(as.Date(report_start_date) + 365, report_organs, TRUE)
```

## Credits
![TARGET-UK: The Thermal Ablation Registry - Getting Evidence Together](../www/TARGETPlotterLogo.png)
<br>
Report Developer: Dr. Paul Lyon, FRCR<br>
TARGET-UK Lead: Dr. Paul Lyon, FRCR
